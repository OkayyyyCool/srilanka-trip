<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LankaBuddy ‚ù§Ô∏è</title>
    
    <!-- iOS Web App Config -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LankaBuddy">
    <!-- Uses the local icon.jpg for the app icon -->
    <link rel="apple-touch-icon" href="icon.jpg">

    <!-- PWA Manifest Placeholder (Will be filled by JS) -->
    <link rel="manifest" id="pwa-manifest">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Dynamic Manifest Script -->
    <script>
        // This script runs immediately to fix the Icon URL for Android PWA install
        (function() {
            const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);
            const iconUrl = baseUrl + 'icon.jpg';

            const manifest = {
                "name": "LankaBuddy",
                "short_name": "LankaBuddy",
                "start_url": ".",
                "display": "standalone",
                "background_color": "#f0fdfc",
                "theme_color": "#0d9488",
                "icons": [
                    { "src": iconUrl, "sizes": "192x192", "type": "image/jpeg", "purpose": "maskable" },
                    { "src": iconUrl, "sizes": "512x512", "type": "image/jpeg", "purpose": "maskable" }
                ]
            };

            const stringManifest = JSON.stringify(manifest);
            const blob = new Blob([stringManifest], {type: 'application/json'});
            const manifestURL = URL.createObjectURL(blob);
            document.querySelector('#pwa-manifest').setAttribute('href', manifestURL);
        })();
    </script>

    <style>
        body { font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .tab-active { color: #0d9488; border-top: 3px solid #0d9488; }
        .tab-inactive { color: #9ca3af; border-top: 3px solid transparent; }
        html { scroll-behavior: smooth; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .timeline-line {
            position: absolute; left: 20px; top: 0; bottom: 0; width: 2px; background: #e5e7eb; z-index: 0;
        }
        
        /* Modal Animation */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 200ms, transform 200ms; }
        .modal-exit { opacity: 1; transform: scale(1); }
        .modal-exit-active { opacity: 0; transform: scale(0.95); transition: opacity 200ms, transform 200ms; }

        /* Chat Styling */
        .chat-bubble { max-width: 80%; padding: 10px 14px; border-radius: 16px; font-size: 13px; line-height: 1.4; margin-bottom: 8px; position: relative; }
        .chat-user { background-color: #0d9488; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .chat-ai { background-color: #f3f4f6; color: #1f2937; align-self: flex-start; border-bottom-left-radius: 4px; border: 1px solid #e5e7eb; }
        
        /* Typing Indicator */
        .typing-dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; background-color: #9ca3af; animation: typing 1.4s infinite ease-in-out both; margin: 0 1px; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        /* Floating Button Animation */
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-5px); } 100% { transform: translateY(0px); } }
        .animate-float { animation: float 3s ease-in-out infinite; }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen pb-24">

    <!-- Header -->
    <header class="relative text-white pt-12 pb-6 px-6 rounded-b-[2rem] shadow-lg z-30 sticky top-0 overflow-hidden bg-cover bg-center" style="background-image: url('header.jpg');">
        <div class="absolute inset-0 bg-black/40 z-0"></div>
        
        <div class="flex justify-between items-end relative z-10">
            <div>
                <p class="text-teal-100 text-sm font-medium mb-1 drop-shadow-md">Dec 24 - Jan 3</p>
                <h1 class="text-3xl font-bold drop-shadow-md">Stuti's 2025 Year-End Trip</h1>
            </div>
            <div class="text-right">
                <!-- Time Box (Liquid Glass Style) -->
                <div class="bg-gradient-to-br from-white/20 to-white/5 backdrop-blur-xl rounded-3xl border border-white/30 shadow-[0_8px_32px_0_rgba(0,0,0,0.1)] flex flex-col items-center justify-center w-28 h-28 relative overflow-hidden">
                    <div class="absolute -top-6 -left-6 w-16 h-16 bg-white/10 rounded-full blur-xl pointer-events-none"></div>
                    <div id="sl-time" class="text-3xl font-bold drop-shadow-sm leading-none mb-1 tracking-tight relative z-10">--:--</div>
                    <div id="sl-time-12" class="text-xs font-medium text-teal-50 mb-2 relative z-10">--:--</div>
                    <p class="text-[9px] text-teal-50 uppercase tracking-widest font-medium border-t border-white/20 pt-1 w-full text-center relative z-10">Sri Lanka</p>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main id="main-container" class="flex-1 relative">
        
        <!-- SECTION: DASHBOARD (Default) -->
        <section id="view-dashboard" class="p-4 space-y-4 fade-in">
            
            <!-- PWA Install Prompt (Android/Desktop) -->
            <div id="install-prompt" class="hidden bg-teal-800 rounded-2xl p-5 shadow-xl text-white relative overflow-hidden mb-6">
                 <div class="relative z-10">
                     <div class="flex justify-between items-start">
                         <div>
                             <h2 class="font-bold text-lg text-white">Get the App!</h2>
                             <p class="text-xs text-teal-100 mt-1 mb-3 pr-4">Install LankaBuddy for easier access.</p>
                         </div>
                         <div class="bg-teal-700/50 p-2 rounded-lg"><i class="fa-solid fa-download text-white"></i></div>
                     </div>
                     <button onclick="installApp()" class="w-full bg-white text-teal-800 py-3 rounded-xl font-bold text-sm shadow hover:bg-gray-50 transition flex items-center justify-center space-x-2">
                         <i class="fa-solid fa-circle-arrow-down"></i><span>Install Now</span>
                     </button>
                     <p id="manual-install-text" class="hidden text-[10px] text-teal-200 mt-2 text-center border-t border-teal-700 pt-2">
                         Tap <i class="fa-solid fa-ellipsis-vertical mx-1"></i> (menu) above and select <b>"Add to Home Screen"</b> or <b>"Install App"</b>.
                     </p>
                 </div>
                 <i class="fa-solid fa-mobile-screen absolute -bottom-6 -right-6 text-9xl text-white opacity-5 rotate-12"></i>
            </div>

            <!-- iOS Install Hint -->
            <div id="ios-install-hint" class="hidden bg-white rounded-2xl p-5 shadow-md border border-teal-100 relative mb-6">
                <button onclick="this.parentElement.style.display='none'" class="absolute top-2 right-2 text-gray-300 hover:text-gray-500"><i class="fa-solid fa-xmark"></i></button>
                <div class="flex items-start space-x-4">
                    <img src="icon.jpg" class="w-12 h-12 rounded-xl object-cover shadow-sm" alt="Icon" onerror="this.src='header.jpg'">
                    <div>
                        <h3 class="font-bold text-gray-800">Install LankaBuddy</h3>
                        <p class="text-xs text-gray-500 mt-1 leading-relaxed">
                            To install on iPhone:<br>
                            1. Tap <span class="font-bold text-blue-500"><i class="fa-solid fa-arrow-up-from-bracket"></i> Share</span> below.<br>
                            2. Scroll & tap <span class="font-bold text-gray-700"><i class="fa-regular fa-square-plus"></i> Add to Home Screen</span>.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Quick Connect -->
            <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
                <div class="flex items-center space-x-2 mb-4">
                    <i class="fa-solid fa-address-book text-gray-400"></i>
                    <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Quick Connect</h2>
                </div>
                <div id="contacts-container" class="grid grid-cols-2 gap-4"></div>
            </div>

            <!-- Important Docs (Updated: Green Background, White Tabs) -->
            <div class="bg-teal-50 rounded-2xl p-5 shadow-sm border border-teal-100">
                <div class="flex items-center space-x-2 mb-4">
                    <i class="fa-solid fa-folder-open text-teal-600"></i>
                    <h2 class="text-xs font-bold text-teal-600 uppercase tracking-wider">Important Docs</h2>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="switchTab('flights')" class="bg-white border border-teal-100 p-3 rounded-xl flex items-center space-x-3 hover:bg-teal-50 transition w-full text-left shadow-sm">
                        <i class="fa-solid fa-ticket text-teal-600"></i><span class="text-sm font-medium text-teal-900">Flights</span>
                    </button>
                    <button onclick="switchTab('hotels')" class="bg-white border border-teal-100 p-3 rounded-xl flex items-center space-x-3 hover:bg-teal-50 transition w-full text-left shadow-sm">
                        <i class="fa-solid fa-hotel text-teal-600"></i><span class="text-sm font-medium text-teal-900">Hotels</span>
                    </button>
                    <button onclick="switchTab('visa')" class="bg-white border border-teal-100 p-3 rounded-xl flex items-center space-x-3 hover:bg-teal-50 transition w-full text-left shadow-sm">
                        <i class="fa-solid fa-passport text-teal-600"></i><span class="text-sm font-medium text-teal-900">Visa & Other docs</span>
                    </button>
                    <button onclick="switchTab('map')" class="bg-white border border-teal-100 p-3 rounded-xl flex items-center space-x-3 hover:bg-teal-50 transition w-full text-left shadow-sm">
                        <i class="fa-solid fa-map text-teal-600"></i><span class="text-sm font-medium text-teal-900">Travel</span>
                    </button>
                </div>
            </div>

            <!-- Quick Share (Updated: Added Icon) -->
            <div class="bg-indigo-50 rounded-2xl p-5 shadow-sm border border-indigo-100">
                <div class="flex items-center space-x-2 mb-4">
                    <i class="fa-solid fa-share-nodes text-indigo-500"></i>
                    <h2 class="text-xs font-bold text-indigo-500 uppercase tracking-wider">Quick Share</h2>
                </div>
                <div class="space-y-3">
                    <!-- Phone Number -->
                    <div class="flex space-x-2">
                        <input type="tel" id="sl-phone-input" placeholder="My Local Number" class="flex-1 bg-white border border-indigo-200 rounded-xl px-3 py-2 text-sm focus:outline-none focus:border-indigo-400 text-gray-700 font-medium">
                        <button onclick="sharePhoneNumber()" class="bg-indigo-600 text-white w-10 h-10 rounded-xl flex items-center justify-center shadow-md active:scale-95 transition">
                            <i class="fa-solid fa-share-nodes"></i>
                        </button>
                    </div>
                    
                    <!-- Share Location -->
                    <button onclick="shareLocation()" class="w-full bg-white border border-indigo-200 text-indigo-700 py-3 rounded-xl font-bold text-sm shadow-sm flex items-center justify-center space-x-2 active:scale-95 transition hover:bg-indigo-50">
                        <i class="fa-solid fa-location-crosshairs text-indigo-500"></i>
                        <span>Share Live Location</span>
                    </button>
                </div>
            </div>

            <!-- SOS / Emergency -->
            <div class="bg-red-50 rounded-2xl p-5 shadow-sm border border-red-100">
                <div class="flex items-center space-x-2 mb-4">
                    <i class="fa-solid fa-triangle-exclamation text-red-600"></i>
                    <h2 class="text-xs font-bold text-red-600 uppercase tracking-wider">Emergency</h2>
                </div>
                <div class="space-y-3">
                    <div class="bg-white p-3 rounded-xl shadow-sm border border-red-100 flex items-center justify-between">
                        <div class="flex flex-col">
                            <span class="font-bold text-sm text-gray-800">Indian High Commission</span>
                            <span class="text-xs text-gray-500">Colombo ‚Ä¢ 24/7 Helpline</span>
                        </div>
                        <div class="flex space-x-2">
                            <a href="https://maps.app.goo.gl/2mj4LwLkhvBUTu6U6" target="_blank" class="w-10 h-10 rounded-full bg-teal-50 flex items-center justify-center text-teal-600 border border-teal-100 active:scale-95 transition">
                                <i class="fa-solid fa-map-location-dot"></i>
                            </a>
                            <button onclick="openExternalLink('https://www.hcicolombo.gov.in/page/contact-us/')" class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-600 border border-blue-100 active:scale-95 transition">
                                <i class="fa-solid fa-globe"></i>
                            </button>
                            <a href="tel:+94773727832" class="w-10 h-10 rounded-full bg-red-600 flex items-center justify-center text-white shadow-md active:scale-95 transition">
                                <i class="fa-solid fa-phone"></i>
                            </a>
                        </div>
                    </div>
                    <div class="flex space-x-3">
                        <a href="tel:119" class="flex-1 bg-white p-3 rounded-xl shadow-sm border border-gray-200 text-center">
                            <div class="text-xl font-bold text-gray-800">119</div><div class="text-xs text-gray-500">Police</div>
                        </a>
                        <a href="tel:110" class="flex-1 bg-white p-3 rounded-xl shadow-sm border border-gray-200 text-center">
                            <div class="text-xl font-bold text-gray-800">110</div><div class="text-xs text-gray-500">Ambulance</div>
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="text-center text-xs text-gray-400 mt-8 mb-8 pb-4">Made with üíñ by Kim-Shin</div>
        </section>

        <!-- SECTION: FLIGHTS -->
        <section id="view-flights" class="p-4 hidden pb-20">
            <button onclick="switchTab('dashboard')" class="mb-4 flex items-center text-teal-600 font-medium text-sm">
                <i class="fa-solid fa-chevron-left mr-2"></i> Back to Dashboard
            </button>
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Flight Tickets</h2>
                <a href="https://drive.google.com/drive/folders/1Bkudvme9YJJqUq0f1gbVRW0QaH_QBznN?usp=sharing" target="_blank" class="text-xs text-teal-600 font-medium underline">Open Drive Folder</a>
            </div>
            <div id="flights-container" class="space-y-4"></div>
            <button onclick="openModal('flight')" class="w-full mt-6 py-4 rounded-xl border-2 border-dashed border-gray-300 text-gray-500 font-medium flex items-center justify-center space-x-2 hover:bg-gray-50 transition">
                <i class="fa-solid fa-plus"></i><span>Add Another Flight</span>
            </button>
        </section>

        <!-- SECTION: HOTELS -->
        <section id="view-hotels" class="p-4 hidden pb-20">
            <button onclick="switchTab('dashboard')" class="mb-4 flex items-center text-teal-600 font-medium text-sm">
                <i class="fa-solid fa-chevron-left mr-2"></i> Back to Dashboard
            </button>
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Hotel Bookings</h2>
                <a href="https://drive.google.com/drive/folders/1Bkudvme9YJJqUq0f1gbVRW0QaH_QBznN?usp=sharing" target="_blank" class="text-xs text-teal-600 font-medium underline">Open Drive Folder</a>
            </div>
            <div id="hotels-container" class="space-y-4"></div>
            <button onclick="openModal('hotel')" class="w-full mt-6 py-4 rounded-xl border-2 border-dashed border-gray-300 text-gray-500 font-medium flex items-center justify-center space-x-2 hover:bg-gray-50 transition">
                <i class="fa-solid fa-plus"></i><span>Add Another Stay</span>
            </button>
        </section>

        <!-- SECTION: VISA -->
        <section id="view-visa" class="p-4 hidden pb-20">
            <button onclick="switchTab('dashboard')" class="mb-4 flex items-center text-teal-600 font-medium text-sm">
                <i class="fa-solid fa-chevron-left mr-2"></i> Back to Dashboard
            </button>
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Visa & Docs</h2>
                <a href="https://drive.google.com/drive/folders/1Bkudvme9YJJqUq0f1gbVRW0QaH_QBznN?usp=sharing" target="_blank" class="text-xs text-teal-600 font-medium underline">Open Drive Folder</a>
            </div>
            <div id="visas-container" class="space-y-4"></div>
            <button onclick="openModal('visa')" class="w-full mt-6 py-4 rounded-xl border-2 border-dashed border-gray-300 text-gray-500 font-medium flex items-center justify-center space-x-2 hover:bg-gray-50 transition">
                <i class="fa-solid fa-plus"></i><span>Add Document</span>
            </button>
        </section>

        <!-- SECTION: MAP & TRANSPORT -->
        <section id="view-map" class="p-4 hidden pb-20">
            <button onclick="switchTab('dashboard')" class="mb-4 flex items-center text-teal-600 font-medium text-sm">
                <i class="fa-solid fa-chevron-left mr-2"></i> Back to Dashboard
            </button>
            
            <div class="mb-8">
                <h2 class="text-2xl font-bold mb-4">Taxi & Transport</h2>
                <div class="grid grid-cols-1 gap-4">
                     <a href="https://m.uber.com/ul" target="_blank" class="bg-black text-white p-4 rounded-xl flex items-center justify-between shadow-lg active:scale-95 transition">
                         <div class="flex items-center space-x-3">
                             <div class="bg-gray-800 w-10 h-10 rounded-full flex items-center justify-center"><i class="fa-brands fa-uber text-xl"></i></div>
                             <div><span class="font-bold block">Uber</span><span class="text-xs text-gray-400">Request a ride</span></div>
                         </div>
                         <i class="fa-solid fa-chevron-right text-gray-600"></i>
                     </a>
                     
                     <button onclick="openPickMe()" class="w-full bg-yellow-400 text-black p-4 rounded-xl shadow-lg active:scale-95 transition flex items-center justify-between">
                         <div class="flex items-center space-x-3">
                             <div class="bg-yellow-500/50 w-10 h-10 rounded-full flex items-center justify-center border border-yellow-600/20 shrink-0"><i class="fa-solid fa-taxi text-xl"></i></div>
                             <div class="text-left">
                                 <div class="flex items-center space-x-2"><span class="font-bold text-lg">PickMe</span></div>
                                 <span class="text-xs font-medium opacity-70 block mb-1">Best Local Taxi App</span>
                                 <div class="bg-white/30 backdrop-blur-md border border-white/40 rounded-lg p-1.5 flex items-start gap-1.5 max-w-[200px]">
                                     <div class="bg-yellow-900/10 w-3 h-3 rounded-full flex items-center justify-center shrink-0 mt-0.5">
                                         <span class="text-[8px] font-extrabold text-yellow-900">!</span>
                                     </div>
                                     <span class="text-[9px] font-bold text-yellow-900 leading-tight text-left">If app doesn't open directly, it will open the app store. Please continue to open the app from there.</span>
                                 </div>
                             </div>
                         </div>
                         <i class="fa-solid fa-chevron-right text-black/50 text-lg ml-1 shrink-0"></i>
                     </button>
                </div>
            </div>

            <div class="mb-8">
                <h2 class="text-2xl font-bold mb-4">Food & Delivery</h2>
                <div class="grid grid-cols-1 gap-4">
                     <button onclick="openUberEats()" class="w-full bg-green-100 text-green-900 p-4 rounded-xl flex items-center justify-between shadow-lg active:scale-95 transition border border-green-200">
                         <div class="flex items-center space-x-3">
                             <div class="bg-white w-10 h-10 rounded-full flex items-center justify-center text-green-600 shadow-sm"><i class="fa-solid fa-utensils text-xl"></i></div>
                             <div class="text-left"><span class="font-bold block text-lg">Uber Eats</span><span class="text-xs text-green-700">Order Food</span></div>
                         </div>
                         <i class="fa-solid fa-chevron-right text-green-400"></i>
                     </button>
                </div>
            </div>

            <h2 class="text-xl font-bold mb-4">Trip Locations</h2>
            <div id="maps-container" class="space-y-4"></div>
            <button onclick="openModal('map')" class="w-full mt-6 py-4 rounded-xl border-2 border-dashed border-gray-300 text-gray-500 font-medium flex items-center justify-center space-x-2 hover:bg-gray-50 transition">
                <i class="fa-solid fa-plus"></i><span>Add Location</span>
            </button>
        </section>

        <!-- SECTION: ITINERARY (Plan) -->
        <section id="view-plan" class="p-4 hidden pb-20">
            <h2 class="text-xl font-bold mb-6 px-2">Your Itinerary</h2>
            <div class="relative pl-2" id="itinerary-container"><div class="timeline-line"></div></div>
            <button onclick="openModal('itinerary')" class="w-full mt-6 py-4 rounded-xl border-2 border-dashed border-gray-300 text-gray-500 font-medium flex items-center justify-center space-x-2 hover:bg-gray-50 transition">
                <i class="fa-solid fa-plus"></i><span>Add New Plan</span>
            </button>
        </section>

        <!-- SECTION: TOOLS -->
        <section id="view-tools" class="p-4 hidden pb-24">
            <!-- Translate -->
            <div class="bg-gradient-to-br from-teal-500 to-teal-700 rounded-2xl p-6 shadow-md mb-6 text-white relative">
                <h3 class="font-bold text-lg mb-2"><i class="fa-solid fa-language mr-2"></i>Translate</h3>
                <p class="text-xs text-teal-100 mb-4">Type English to get Sinhala + pronunciation!</p>
                <div class="space-y-3">
                    <textarea id="translate-input" rows="2" class="w-full rounded-xl p-3 text-gray-800 text-sm outline-none shadow-inner" placeholder="Type here (e.g. How much is this?)"></textarea>
                    <button onclick="translateWithGemini()" class="w-full bg-white text-teal-700 font-bold py-3 rounded-xl shadow hover:bg-gray-50 transition active:scale-95 flex items-center justify-center space-x-2" id="btn-translate">
                        <i class="fa-solid fa-wand-magic-sparkles text-xs"></i><span>Translate</span>
                    </button>
                    <!-- Updated Result Area with Audio Button -->
                    <div id="translate-result" class="hidden bg-black/20 rounded-xl p-3 mt-3 border border-white/10">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-[10px] uppercase text-teal-200 mb-1">Translation:</p>
                                <p id="t-sinhala" class="text-xl font-bold mb-1"></p>
                                <p id="t-phonetic" class="text-xs italic text-teal-100"></p>
                            </div>
                            <button id="btn-play-translation" class="bg-white/20 hover:bg-white/30 text-white w-10 h-10 rounded-full flex items-center justify-center transition active:scale-95 shrink-0 ml-2">
                                <i class="fa-solid fa-volume-high"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Currency -->
            <div class="bg-white rounded-2xl p-6 shadow-md mb-6 relative overflow-hidden">
                <div class="absolute -right-4 -top-4 text-gray-100 text-9xl z-0"><i class="fa-solid fa-coins"></i></div>
                <h3 class="font-bold text-lg mb-4 relative z-10">Rupee Converter</h3>
                <div class="space-y-4 relative z-10">
                    <div>
                        <label class="text-xs text-gray-500 font-bold uppercase">Indian Rupee (INR)</label>
                        <input type="number" id="inr-input" placeholder="100" class="w-full text-2xl font-bold border-b-2 border-teal-100 focus:border-teal-600 outline-none py-2 bg-transparent">
                    </div>
                    <div class="flex items-center justify-center"><i class="fa-solid fa-arrow-down text-teal-600"></i></div>
                    <div>
                        <label class="text-xs text-gray-500 font-bold uppercase">Sri Lankan Rupee (LKR)</label>
                        <div id="lkr-output" class="text-3xl font-bold text-teal-700">344.00</div>
                        <p class="text-xs text-gray-400 mt-1">*Approx rate: 1 INR = 3.44 LKR</p>
                    </div>
                </div>
            </div>

            <!-- LocalSend -->
            <div class="mb-6">
                <button onclick="openLocalSend()" class="w-full bg-orange-50 border border-orange-100 p-4 rounded-2xl shadow-sm flex items-center justify-between active:scale-95 transition text-left">
                    <div class="flex items-center space-x-4 overflow-hidden">
                        <img src="localsend.jpg" class="w-10 h-10 rounded-full object-cover shadow-sm shrink-0" alt="LocalSend">
                        <div class="text-left min-w-0">
                            <span class="font-bold text-gray-800 block text-lg">LocalSend</span>
                            <span class="text-[10px] text-orange-800 leading-tight block">AirDrop alternative to share photos/videos across platforms</span>
                        </div>
                    </div>
                    <i class="fa-solid fa-chevron-right text-orange-300 ml-2 shrink-0"></i>
                </button>
            </div>

            <!-- Niyo -->
            <div class="mb-6">
                <button onclick="openNiyo()" class="w-full bg-blue-50 border border-blue-100 p-4 rounded-2xl shadow-sm flex items-center justify-between active:scale-95 transition text-left">
                    <div class="flex items-center space-x-4 overflow-hidden">
                        <img src="niyo.jpg" class="w-10 h-10 rounded-full object-cover shadow-sm shrink-0" alt="Niyo">
                        <div class="text-left min-w-0">
                            <span class="font-bold text-gray-800 block text-lg">Niyo Global</span>
                            <span class="text-[10px] text-blue-800 leading-tight block">Manage travel card & forex</span>
                        </div>
                    </div>
                    <i class="fa-solid fa-chevron-right text-blue-300 ml-2 shrink-0"></i>
                </button>
            </div>

            <h3 class="font-bold text-lg mb-4 px-2">Common Phrases</h3>
            <div id="translate-container" class="grid gap-3"></div>
        </section>
    </main>

    <!-- FAB -->
    <button onclick="openChat()" class="fixed bottom-24 right-4 bg-teal-600 text-white p-0 rounded-full shadow-xl z-40 active:scale-90 transition animate-float hover:bg-teal-700 flex items-center justify-center w-14 h-14 border-4 border-white/20 overflow-hidden">
        <img src="ai_icon.jpg" class="w-full h-full object-cover" alt="AI">
    </button>

    <!-- Chat Modal -->
    <div id="chat-modal" class="fixed inset-0 bg-white z-[60] hidden flex flex-col">
        <div class="bg-teal-600 text-white p-4 pb-6 flex items-center justify-between shadow-lg relative z-10">
            <div class="flex items-center space-x-3">
                <img src="ai_icon.jpg" class="w-10 h-10 rounded-full object-cover border-2 border-white/30 shadow-sm">
                <div><h3 class="font-bold text-lg">Kim Shin ‚ú®</h3><p class="text-xs text-teal-100">Ask about your trip!</p></div>
            </div>
            <button onclick="closeChat()" class="bg-black/20 p-2 rounded-full hover:bg-black/30 transition"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 bg-gray-50 flex flex-col space-y-3 pb-48">
            <div class="chat-bubble chat-ai">Hello! I am Kim Shin, your buddy for this trip. I know about your itinerary! Ask me anything about food, places, or what to pack! üå¥üêò</div>
        </div>
        <div class="bg-white border-t border-gray-200 fixed bottom-0 w-full z-20 pb-safe transition-all duration-300">
            <div id="chat-suggestions" class="px-4 pt-3 pb-1 flex gap-2 overflow-x-auto no-scrollbar fade-in">
                <button onclick="useSuggestion('What is this landmark? üì∏')" class="whitespace-nowrap bg-teal-50 text-teal-700 text-[10px] font-medium px-3 py-1.5 rounded-full border border-teal-100 shadow-sm active:scale-95 transition flex items-center gap-1"><i class="fa-solid fa-camera"></i> Identify this</button>
                <button onclick="useSuggestion('Translate this menu üìÑ')" class="whitespace-nowrap bg-teal-50 text-teal-700 text-[10px] font-medium px-3 py-1.5 rounded-full border border-teal-100 shadow-sm active:scale-95 transition flex items-center gap-1"><i class="fa-solid fa-language"></i> Translate menu</button>
                <button onclick="useSuggestion('Best dinner spots nearby? üçú')" class="whitespace-nowrap bg-teal-50 text-teal-700 text-[10px] font-medium px-3 py-1.5 rounded-full border border-teal-100 shadow-sm active:scale-95 transition">Dinner spots? üçú</button>
                <button onclick="useSuggestion('What should I pack for Ella? üéí')" class="whitespace-nowrap bg-teal-50 text-teal-700 text-[10px] font-medium px-3 py-1.5 rounded-full border border-teal-100 shadow-sm active:scale-95 transition">Packing tips üéí</button>
            </div>
            <div id="image-preview-container" class="hidden px-4 py-2 bg-gray-50 border-b border-gray-100 flex items-center justify-between">
                <div class="flex items-center space-x-3"><img id="image-preview" class="w-12 h-12 rounded-lg object-cover border border-gray-200 shadow-sm"><span class="text-xs text-gray-500 font-medium">Image attached</span></div>
                <button onclick="clearImageSelection()" class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 text-gray-500 hover:bg-red-100 hover:text-red-500 transition"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-4">
                <div class="flex space-x-2 items-end">
                    <input type="file" id="chat-file-input" accept="image/*" class="hidden" onchange="handleImageSelect(this)">
                    <button onclick="document.getElementById('chat-file-input').click()" class="bg-gray-100 text-gray-500 w-12 h-12 rounded-xl flex items-center justify-center active:scale-95 transition hover:bg-gray-200 hover:text-teal-600"><i class="fa-solid fa-camera text-lg"></i></button>
                    <input type="text" id="chat-input" placeholder="Ask or show me something..." class="flex-1 bg-gray-100 border-none rounded-xl px-4 py-3 focus:ring-2 focus:ring-teal-500 outline-none h-12">
                    <button onclick="sendMessage()" class="bg-teal-600 text-white w-12 h-12 rounded-xl flex items-center justify-center shadow-lg active:scale-95 transition hover:bg-teal-700"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Entry Modal -->
    <div id="universal-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-xl transform transition-all scale-95 opacity-0" id="universal-modal-content">
            <h3 class="text-lg font-bold mb-4" id="modal-title">Add Details</h3>
            <div class="space-y-4">
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1" id="label-1">Title</label><input type="text" id="input-1" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 text-sm focus:border-teal-500 outline-none"></div>
                <div id="group-2"><label class="block text-xs font-bold text-gray-500 uppercase mb-1" id="label-2">Date</label><input type="text" id="input-2" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 text-sm focus:border-teal-500 outline-none"></div>
                <div id="drive-info-box" class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                    <p class="text-xs text-blue-800 mb-2"><i class="fa-solid fa-circle-info mr-1"></i> Upload to Drive first, then paste link.</p>
                    <a href="https://drive.google.com/drive/folders/1Bkudvme9YJJqUq0f1gbVRW0QaH_QBznN?usp=sharing" target="_blank" class="block w-full text-center bg-white text-blue-600 py-2 rounded border border-blue-200 text-xs font-bold hover:bg-blue-50">Open Drive Folder</a>
                </div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1" id="label-3">Link 1</label><input type="text" id="input-3" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 text-sm focus:border-teal-500 outline-none"></div>
                <div id="group-4"><label class="block text-xs font-bold text-gray-500 uppercase mb-1" id="label-4">Link 2</label><input type="text" id="input-4" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 text-sm focus:border-teal-500 outline-none"></div>
            </div>
            <div class="flex space-x-3 mt-6">
                <button onclick="closeModal()" class="flex-1 py-3 text-gray-500 font-medium">Cancel</button>
                <button onclick="saveItem()" class="flex-1 bg-teal-600 text-white rounded-xl font-bold shadow-lg hover:bg-teal-700">Save</button>
            </div>
        </div>
    </div>

    <!-- Bottom Nav -->
    <nav class="bg-white border-t border-gray-200 pb-safe pt-2 px-6 flex justify-between items-center z-50 h-20 shadow-[0_-5px_10px_rgba(0,0,0,0.02)] fixed bottom-0 w-full left-0">
        <button onclick="switchTab('dashboard')" class="nav-btn flex flex-col items-center space-y-1 w-16" id="nav-dashboard"><i class="fa-solid fa-house text-xl mb-1"></i><span class="text-[10px] font-medium">Home</span></button>
        <button onclick="switchTab('plan')" class="nav-btn flex flex-col items-center space-y-1 w-16" id="nav-plan"><i class="fa-solid fa-map-location-dot text-xl mb-1"></i><span class="text-[10px] font-medium">Plan</span></button>
        <button onclick="switchTab('tools')" class="nav-btn flex flex-col items-center space-y-1 w-16" id="nav-tools"><i class="fa-solid fa-briefcase text-xl mb-1"></i><span class="text-[10px] font-medium">Tools</span></button>
    </nav>

    <script>
        // --- Configuration ---
        let currentType = ''; 
        let currentEditIndex = -1;
        let apiKey = "AIzaSyD8n4HNYts2dRgOtIauZpozzl1tMBW7pt0"; 
        let selectedImageBase64 = null;
        let selectedImageMime = null;

        // --- Data ---
        const defaultItinerary = [
            { date: "2025-12-24", title: "Delhi to Hyderabad", loc: "Sneha's Place", icon: "fa-plane-departure", details: "Flight: Indigo (2 PM). Stay at Sneha." },
            { date: "2025-12-25", title: "Fly to Colombo", loc: "Murphy‚Äôs Villa", icon: "fa-plane", details: "HYD to CMB (8:45 AM - 10:45 AM). Relax and check-in." },
            { date: "2025-12-26", title: "Travel to Sigiriya", loc: "Boutique Hotel", icon: "fa-bus", details: "Travel by Bus. Explore Sigiriya Fortress (Lion Rock)." },
            { date: "2025-12-27", title: "Sigiriya to Kandy", loc: "Hill Crest Greens", icon: "fa-city", details: "Travel to Kandy. Roam around the city, visit Temple of Tooth." },
            { date: "2025-12-28", title: "Train to Nuwara Eliya", loc: "Ella Guest House", icon: "fa-train", details: "Scenic Train ride! Then car to Ella. Check-in for 3 nights." },
            { date: "2025-12-29", title: "Adam's Peak Hike", loc: "Ella", icon: "fa-mountain", details: "Hiking, Tea Plantations, Waterfalls." },
            { date: "2025-12-30", title: "To Mirissa", loc: "Beach Area", icon: "fa-umbrella-beach", details: "Travel to coast. Explore beaches." },
            { date: "2025-12-31", title: "Snorkeling & NYE", loc: "Mirissa", icon: "fa-champagne-glasses", details: "Morning: Snorkeling. Evening: New Year's Party!" },
            { date: "2026-01-01", title: "To Colombo/Negombo", loc: "Near Airport", icon: "fa-car", details: "Travel back towards capital/airport area." },
            { date: "2026-01-02", title: "Fly to Hyderabad", loc: "Hyderabad", icon: "fa-plane-arrival", details: "Colombo to HYD." },
            { date: "2026-01-03", title: "Home Sweet Home", loc: "Delhi", icon: "fa-house-chimney", details: "HYD to DEL." }
        ];

        const defaultFlights = [
            { title: "Delhi to Hyderabad", date: "2025-12-24", link1: "https://drive.google.com/file/d/12XgJcZeCWtT0Joqf5PbVJeOX-a4L-l1j/view?usp=drive_link", link2: "" },
            { title: "Hyderabad to Colombo", date: "2025-12-25", link1: "https://drive.google.com/file/d/1ipk1moPSCL3FSxHaZ18et44Nkp2hmoUO/view?usp=sharing", link2: "" },
            { title: "Colombo to Hyderabad", date: "2026-01-02", link1: "https://drive.google.com/file/d/1Hy3m38VOvwDACErdxzRupuqNICt1aWj_/view?usp=drive_link", link2: "" },
            { title: "Hyderabad to Delhi", date: "2026-01-03", link1: "https://drive.google.com/file/d/12XgJcZeCWtT0Joqf5PbVJeOX-a4L-l1j/view?usp=drive_link", link2: "" }
        ];

        const defaultHotels = [
            { title: "Murphy‚Äôs Villa, Colombo", date: "2025-12-25", link1: "", link2: "" },
            { title: "Boutique Hotel, Sigiriya", date: "2025-12-26", link1: "", link2: "" },
            { title: "Hill Crest Greens, Kandy", date: "2025-12-27", link1: "", link2: "" },
            { title: "Guest House, Ella", date: "2025-12-28", link1: "", link2: "" },
            { title: "Beach Stay, Mirissa", date: "2025-12-30", link1: "", link2: "" },
            { title: "Colombo Stay", date: "2026-01-01", link1: "", link2: "" }
        ];

        const defaultVisa = [
            { title: "Sri Lanka Visa", date: "Valid 30 days from arrival", link1: "", link2: "" },
            { title: "Travel Insurance", date: "Full Trip", link1: "", link2: "" }
        ];
        
        const defaultMaps = [
            { title: "Sigiriya Fortress", loc: "Sigiriya", query: "https://maps.app.goo.gl/PkJQxnNG5Fj79Ag88" },
            { title: "Kandy", loc: "Kandy City", query: "https://maps.app.goo.gl/6qqNsPmswbd4it7TA" },
            { title: "Ella Town", loc: "Ella", query: "https://maps.app.goo.gl/v6k2CX6XSJcz1zAT8" },
            { title: "Adam's Peak", loc: "Sripada", query: "https://maps.app.goo.gl/c1hiRFSFhTnKjRcBA" },
            { title: "Mirissa Beach", loc: "Mirissa", query: "https://maps.app.goo.gl/63dXmesi4R17Ttz26" },
        ];
        
        const defaultContacts = [
            { title: "Shreyans", date: "Boyfriend", link1: "918588061305", link2: "918588061305", color: "blue", image: "contact1.jpeg" },
            { title: "Samridhi", date: "Sister", link1: "918586960219", link2: "918586960219", color: "purple", image: "contact2.jpg" }
        ];

        const translations = [
            { en: "Take me to the hotel", si: "Mawa hotel ekata geniyanna" },
            { en: "Stop here", si: "Methana nawaththanna" },
            { en: "How much?", si: "Keeyada?" },
            { en: "Thank you", si: "Istuthi" },
            { en: "Too expensive", si: "Gana wadi" },
            { en: "Water please", si: "Wathura dennna" },
            { en: "Bill please", si: "Bill eka denna" },
            { en: "I don't want", si: "Epa" },
            { en: "Vegetarian?", si: "Eli-valu vitharak?" },
            { en: "Where is the bathroom?", si: "Washroom koheda?" }
        ];

        // --- Functions ---
        // SL Number Persistence & Formatting
        const slPhoneInput = document.getElementById('sl-phone-input');
        if (slPhoneInput) {
            const stored = localStorage.getItem('sl_phone_number');
            if (stored) slPhoneInput.value = stored;

            slPhoneInput.addEventListener('focus', function() {
                if(!this.value) this.value = '+94 ';
            });

            slPhoneInput.addEventListener('input', function() {
                // 1. Maintain Prefix
                let val = this.value;
                if (!val.startsWith('+94 ')) {
                    // If prefix missing/damaged, strip non-digits and re-add prefix
                    // This handles if user deletes the space or part of +94
                    const rawDigits = val.replace(/\D/g, ''); 
                    // If rawDigits starts with 94, remove it to avoid dupes (simple heuristic)
                    const cleanDigits = rawDigits.startsWith('94') ? rawDigits.substring(2) : rawDigits;
                    val = '+94 ' + cleanDigits;
                }

                // 2. Limit Length (Max 9 digits after prefix)
                const prefix = '+94 ';
                const digitsPart = val.substring(prefix.length).replace(/\D/g, ''); // Get just numbers
                
                if (digitsPart.length > 9) {
                    val = prefix + digitsPart.substring(0, 9);
                } else {
                    val = prefix + digitsPart;
                }
                
                this.value = val;
                localStorage.setItem('sl_phone_number', this.value);
            });
            
            // Extra safety: save on blur (loss of focus)
            slPhoneInput.addEventListener('blur', function() {
                localStorage.setItem('sl_phone_number', this.value);
            });
            // Extra safety: save on change
             slPhoneInput.addEventListener('change', function() {
                localStorage.setItem('sl_phone_number', this.value);
            });
        }

        async function sharePhoneNumber() {
            const num = document.getElementById('sl-phone-input').value;
            if(!num) return alert("Please enter a number first!");
            
            const shareData = {
                title: 'My Sri Lanka Number',
                text: `Here is my local Sri Lanka number: ${num}`
            };

            try {
                if (navigator.share) {
                    await navigator.share(shareData);
                } else {
                    // Fallback
                    prompt("Copy to clipboard:", shareData.text);
                }
            } catch (err) {
                console.log('Error sharing:', err);
            }
        }

        function shareLocation() {
            if (!navigator.geolocation) {
                alert("Geolocation is not supported by this browser.");
                return;
            }
            
            const btn = event.currentTarget; // Get button to show loading state if needed
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Locating...';

            navigator.geolocation.getCurrentPosition(async (position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const mapLink = `https://www.google.com/maps?q=${lat},${lng}`;
                
                const shareData = {
                    title: 'My Location',
                    text: `Hey, just checking in! Here is my current location for safety. üìç\n${mapLink}`
                };

                try {
                    if (navigator.share) {
                        await navigator.share(shareData);
                    } else {
                         // Fallback for desktop or non-supported browsers
                         window.open(`https://wa.me/?text=${encodeURIComponent(shareData.text)}`, '_blank');
                    }
                } catch (err) {
                    console.log('Error sharing:', err);
                } finally {
                     btn.innerHTML = originalText;
                }
            }, (error) => {
                alert("Unable to retrieve your location. Please allow location access.");
                btn.innerHTML = originalText;
            });
        }

async function fetchGeminiResponse(userPrompt, systemContext = "", imageBase64 = null, imageMime = null) {
            if (!apiKey) {
                apiKey = prompt("API Key Required:");
                if(!apiKey) return "Error: No API Key";
            }
            
            // Ensure there are NO spaces inside the quotes
const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
            
            let parts = [{ text: systemContext ? `${systemContext}\n\nUser: ${userPrompt}` : userPrompt }];
            if (imageBase64 && imageMime) parts.push({ inlineData: { mimeType: imageMime, data: imageBase64 } });

            try {
                const response = await fetch(url, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ role: "user", parts: parts }] })
                });
                const data = await response.json();
                
                // --- NEW CODE: Check for API errors explicitly ---
                if (data.error) {
                    console.error("Gemini API Error:", data); // Also logs to browser console (F12)
                    return `‚ö†Ô∏è API Error: ${data.error.message}`;
                }
                // -------------------------------------------------

                return data.candidates?.[0]?.content?.parts?.[0]?.text || "‚ö†Ô∏è No response text. Check console for details.";
            } catch (e) {
                console.error(e);
                return `‚ö†Ô∏è Network Error: ${e.message}`;
            }
        }
        
        function openChat() { document.getElementById('chat-modal').classList.remove('hidden'); }
        function closeChat() { document.getElementById('chat-modal').classList.add('hidden'); }

        function handleImageSelect(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    selectedImageBase64 = e.target.result.split(',')[1];
                    selectedImageMime = file.type;
                    document.getElementById('image-preview').src = e.target.result;
                    document.getElementById('image-preview-container').classList.remove('hidden');
                    const suggestions = document.getElementById('chat-suggestions');
                    if(suggestions) suggestions.style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        }

        function clearImageSelection() {
            document.getElementById('chat-file-input').value = '';
            selectedImageBase64 = null;
            selectedImageMime = null;
            document.getElementById('image-preview-container').classList.add('hidden');
            const suggestions = document.getElementById('chat-suggestions');
            if(suggestions && document.getElementById('chat-messages').childElementCount <= 1) suggestions.style.display = 'flex';
        }

        function useSuggestion(text) {
            const input = document.getElementById('chat-input');
            input.value = text;
            input.focus();
            if (text.includes("Identify") || text.includes("Translate")) {
                const camBtn = document.querySelector('button[onclick*="chat-file-input"]');
                camBtn.classList.add('ring-2', 'ring-teal-500');
                setTimeout(() => camBtn.classList.remove('ring-2', 'ring-teal-500'), 1000);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text && !selectedImageBase64) return;

            const suggestions = document.getElementById('chat-suggestions');
            if(suggestions) suggestions.style.display = 'none';

            const chatBox = document.getElementById('chat-messages');
            let messageHtml = text;
            if (selectedImageBase64) messageHtml += `<br><div class="flex items-center mt-1 space-x-1 opacity-70 italic text-[10px]"><i class="fa-solid fa-image"></i><span>Image attached</span></div>`;
            
            chatBox.innerHTML += `<div class="chat-bubble chat-user">${messageHtml}</div>`;
            input.value = "";
            chatBox.scrollTop = chatBox.scrollHeight;

            const typingId = 'typing-' + Date.now();
            chatBox.innerHTML += `<div id="${typingId}" class="chat-bubble chat-ai"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div>`;
            chatBox.scrollTop = chatBox.scrollHeight;

            const context = `You are Kim Shin, a helpful travel buddy for Stuti's trip to Sri Lanka. Her itinerary: ${JSON.stringify(loadData('itinerary'))}. Flight details: ${JSON.stringify(loadData('flight'))}. Answer strictly about trip/food/culture. Keep concise (<50 words). Analyze attached images if any.`;

            try {
                const response = await fetchGeminiResponse(text, context, selectedImageBase64, selectedImageMime);
                document.getElementById(typingId).remove();
                const formattedResponse = response.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
                chatBox.innerHTML += `<div class="chat-bubble chat-ai">${formattedResponse}</div>`;
                clearImageSelection();
            } catch (e) {
                document.getElementById(typingId).remove();
                chatBox.innerHTML += `<div class="chat-bubble chat-ai text-red-500">Error connecting. Try again.</div>`;
            }
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function translateWithGemini() {
            const input = document.getElementById('translate-input').value;
            if (!input) return alert("Please type something!");
            const btn = document.getElementById('btn-translate');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="typing-dot"></span><span class="typing-dot"></span>';
            btn.disabled = true;

            const prompt = `Translate to Sinhala (Sri Lanka). Output JSON: {"sinhala": "...", "pronunciation": "..."}. Text: "${input}"`;
            try {
                const raw = await fetchGeminiResponse(prompt);
                const jsonStr = raw.replace(/```json|```/g, '').trim();
                const data = JSON.parse(jsonStr);
                document.getElementById('t-sinhala').innerText = data.sinhala;
                document.getElementById('t-phonetic').innerText = data.pronunciation;
                
                // --- ADDED: Bind Audio Button ---
                const playBtn = document.getElementById('btn-play-translation');
                playBtn.onclick = function() { playAudio(data.sinhala); };
                
                document.getElementById('translate-result').classList.remove('hidden');
            } catch (e) {
                if(confirm("AI error. Open Google Translate?")) window.open(`https://www.google.com/search?q=translate+${encodeURIComponent(input)}+to+sinhala`, '_blank');
            }
            btn.innerHTML = originalText;
            btn.disabled = false;
        }

        // --- Common Logic ---
        function updateSriLankaTime() {
            const now = new Date();
            const timeEl = document.getElementById('sl-time');
            const time12El = document.getElementById('sl-time-12');
            if(timeEl) timeEl.innerText = now.toLocaleTimeString('en-US', { timeZone: 'Asia/Colombo', hour: '2-digit', minute: '2-digit', hour12: false });
            if(time12El) time12El.innerText = now.toLocaleTimeString('en-US', { timeZone: 'Asia/Colombo', hour: 'numeric', minute: '2-digit', hour12: true });
        }
        setInterval(updateSriLankaTime, 1000);
        updateSriLankaTime();
        
        function playAudio(text) {
            // Cancel any ongoing speech first to fix iOS overlapping
            window.speechSynthesis.cancel();
            
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'si-LK'; 
                window.speechSynthesis.speak(utterance);
            } else {
                alert("Audio not supported");
            }
        }

        function formatDateToOrdinal(dateStr) {
            const regex = /^\d{4}-\d{2}-\d{2}$/;
            if (!regex.test(dateStr)) return dateStr;
            const dateObj = new Date(dateStr);
            if (isNaN(dateObj)) return dateStr;
            const day = dateObj.getDate();
            const month = dateObj.toLocaleDateString('en-US', { month: 'short' });
            const suffix = (d) => { if (d > 3 && d < 21) return 'th'; switch (d % 10) { case 1: return "st"; case 2: return "nd"; case 3: return "rd"; default: return "th"; } };
            return `${day}${suffix(day)} ${month}`;
        }

        function switchTab(tabName) {
            localStorage.setItem('activeTab', tabName);
            document.querySelectorAll('main > section').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-btn i').forEach(el => el.classList.remove('text-teal-600', 'text-gray-400'));
            document.querySelectorAll('.nav-btn i').forEach(el => el.classList.add('text-gray-400'));
            document.querySelectorAll('.nav-btn span').forEach(el => el.classList.remove('text-teal-600', 'text-gray-400'));
            document.querySelectorAll('.nav-btn span').forEach(el => el.classList.add('text-teal-600'));

            const activeSection = document.getElementById(`view-${tabName}`) || document.getElementById('view-dashboard');
            activeSection.classList.remove('hidden');
            
            const btn = document.getElementById(tabName === 'plan' ? 'nav-plan' : tabName === 'tools' ? 'nav-tools' : 'nav-dashboard');
            if (btn) {
                btn.querySelector('i').classList.remove('text-gray-400');
                btn.querySelector('i').classList.add('text-teal-600');
                btn.querySelector('span').classList.remove('text-gray-400');
                btn.querySelector('span').classList.add('text-teal-600');
            }
            document.getElementById('main-container').scrollTop = 0;
        }

        function openExternalLink(url) { window.open(url, '_blank'); }

        function openPickMe() {
            const ua = navigator.userAgent || navigator.vendor || window.opera;
            if (/android/i.test(ua)) {
                window.location.href = 'market://details?id=com.pickme.passenger';
            } else if (/iPad|iPhone|iPod/.test(ua) && !window.MSStream) {
                setTimeout(() => window.location.href = "https://apps.apple.com/lk/app/pickme-sri-lanka/id1006015699", 1500);
                window.location.href = "pickme://";
            } else {
                window.open("https://pickme.lk/", "_blank");
            }
        }

        function openUberEats() {
            const ua = navigator.userAgent || navigator.vendor || window.opera;
            if (/android/i.test(ua)) {
                window.location.href = 'intent://#Intent;scheme=ubereats;package=com.ubercab.eats;S.browser_fallback_url=https://play.google.com/store/apps/details?id=com.ubercab.eats;end';
            } else if (/iPad|iPhone|iPod/.test(ua) && !window.MSStream) {
                setTimeout(() => window.location.href = "https://apps.apple.com/us/app/uber-eats-food-delivery/id1058959277", 1500);
                window.location.href = "ubereats://";
            } else {
                window.open("https://www.ubereats.com/", "_blank");
            }
        }

        function openLocalSend() {
            const ua = navigator.userAgent || navigator.vendor || window.opera;
            if (/android/i.test(ua)) {
                window.location.href = 'intent:#Intent;action=android.intent.action.MAIN;category=android.intent.category.LAUNCHER;package=org.localsend.localsend_app;S.browser_fallback_url=https://play.google.com/store/apps/details?id=org.localsend.localsend_app;end';
            } else if (/iPad|iPhone|iPod/.test(ua) && !window.MSStream) {
                setTimeout(() => window.location.href = "https://apps.apple.com/us/app/localsend/id1661733229", 1500);
                window.location.href = "localsend://";
            } else {
                window.open("https://localsend.org/", "_blank");
            }
        }

        function openNiyo() {
            const ua = navigator.userAgent || navigator.vendor || window.opera;
            if (/android/i.test(ua)) {
                window.location.href = 'intent:#Intent;action=android.intent.action.MAIN;category=android.intent.category.LAUNCHER;package=finance.global.travel.niyo;S.browser_fallback_url=https://play.google.com/store/apps/details?id=finance.global.travel.niyo;end';
            } else if (/iPad|iPhone|iPod/.test(ua) && !window.MSStream) {
                setTimeout(() => window.location.href = "https://apps.apple.com/in/app/niyo-global-cards-for-travel/id1633946487", 1500);
                window.location.href = "niyoglobal://";
            } else {
                window.open("https://niyo.com/", "_blank");
            }
        }

        function loadData(type) {
            const stored = localStorage.getItem(`sl_trip_${type}s`);
            if(stored) return JSON.parse(stored);
            if(type === 'flight') return defaultFlights;
            if(type === 'hotel') return defaultHotels;
            if(type === 'visa') return defaultVisa;
            if(type === 'contact') return defaultContacts;
            if(type === 'map') return defaultMaps;
            if(type === 'itinerary') return defaultItinerary;
            return [];
        }

        function saveData(type, data) { localStorage.setItem(`sl_trip_${type}s`, JSON.stringify(data)); }
        
        function deleteItem(type, index) {
            if(!confirm("Delete this?")) return;
            const data = loadData(type);
            data.splice(index, 1);
            saveData(type, data);
            if(type === 'contact') renderContacts();
            else if(type === 'map') renderMaps();
            else if(type === 'itinerary') renderItinerary();
            else renderList(type);
        }

        function renderItinerary() {
            const data = loadData('itinerary');
            const container = document.getElementById('itinerary-container');
            container.innerHTML = '<div class="timeline-line"></div>';
            const today = new Date().toISOString().split('T')[0];
            data.forEach((item, index) => {
                const dayStr = formatDateToOrdinal(item.date);
                const isToday = item.date === today;
                const bgColor = isToday ? 'bg-teal-50 border-teal-200' : 'bg-white border-gray-100';
                const dotColor = isToday ? 'bg-teal-600 animate-pulse' : 'bg-teal-200';
                container.innerHTML += `
                    <div class="relative pl-10 pr-2 mb-6 transition-all duration-300">
                        <div class="absolute left-[14px] top-4 w-3 h-3 rounded-full ${dotColor} border-2 border-white z-10"></div>
                        <div class="rounded-xl p-4 shadow-sm border ${bgColor} relative overflow-hidden group">
                             <div class="absolute top-3 right-3 flex space-x-2 z-20">
                                <button onclick="openModal('itinerary', ${index})" class="text-gray-300 hover:text-teal-600 transition p-1 bg-white/80 rounded-full shadow-sm"><i class="fa-solid fa-pen-to-square text-xs"></i></button>
                                <button onclick="deleteItem('itinerary', ${index})" class="text-gray-300 hover:text-red-500 transition p-1 bg-white/80 rounded-full shadow-sm"><i class="fa-solid fa-trash text-xs"></i></button>
                            </div>
                            ${isToday ? '<div class="absolute top-0 left-0 bg-teal-600 text-white text-[10px] px-2 py-1 rounded-br-lg font-bold z-10">TODAY</div>' : ''}
                            <div class="mb-2 ${isToday ? 'mt-4' : ''}"><span class="text-xs font-bold text-gray-400 uppercase tracking-wide">${dayStr}</span></div>
                            <div class="flex items-start space-x-3 mb-2 pr-16">
                                <div class="w-10 h-10 rounded-full bg-teal-100 flex items-center justify-center text-teal-600 shrink-0 mt-0.5"><i class="fa-solid ${item.icon || 'fa-location-dot'}"></i></div>
                                <h3 class="font-bold text-lg text-gray-800 leading-tight">${item.title}</h3>
                            </div>
                            <div class="pl-13 ml-12">
                                <div class="flex items-center text-sm text-gray-600 mb-2"><i class="fa-solid fa-bed text-gray-400 mr-2 text-xs"></i><span>${item.loc}</span></div>
                                <div class="text-sm text-gray-500 bg-gray-50/50 p-3 rounded-lg border border-gray-100">${item.details}</div>
                            </div>
                        </div>
                    </div>`;
            });
        }

        function renderList(type) {
            const data = loadData(type);
            const container = document.getElementById(`${type}s-container`);
            if(!container) return; 
            container.innerHTML = '';
            data.forEach((item, index) => {
                let icon = 'fa-file'; let label1 = 'Doc'; let label2 = 'Doc 2'; let color = 'teal';
                const displayDate = formatDateToOrdinal(item.date);
                if(type === 'flight') { icon = 'fa-plane'; label1 = 'Ticket'; label2 = 'Boarding Pass'; color = 'teal'; }
                if(type === 'hotel') { icon = 'fa-hotel'; label1 = 'Booking'; label2 = 'Map'; color = 'blue'; }
                if(type === 'visa') { icon = 'fa-passport'; label1 = 'View Doc'; label2 = 'Other'; color = 'purple'; }
                
                container.innerHTML += `
                    <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-100 relative group">
                        <div class="absolute top-4 right-4 flex space-x-2 z-20">
                            <button onclick="openModal('${type}', ${index})" class="text-gray-300 hover:text-teal-600 transition p-1"><i class="fa-solid fa-pen-to-square"></i></button>
                            <button onclick="deleteItem('${type}', ${index})" class="text-gray-300 hover:text-red-500 transition p-1"><i class="fa-solid fa-trash"></i></button>
                        </div>
                        <div class="flex justify-between items-start mb-2 pr-8"><h3 class="font-bold text-lg text-gray-800 leading-tight">${item.title}</h3></div>
                        <span class="bg-${color}-50 text-${color}-700 text-xs font-bold px-2 py-1 rounded-md mb-4 inline-block">${displayDate}</span>
                        <div class="space-y-2 mt-2">
                            ${item.link1 ? `<a href="${item.link1}" target="_blank" class="flex items-center justify-between p-3 rounded-lg border border-${color}-100 bg-${color}-50/50 hover:bg-${color}-100 transition group"><div class="flex items-center space-x-3"><div class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-${color}-600 shadow-sm"><i class="fa-solid ${icon}"></i></div><span class="text-sm font-medium text-gray-700 group-hover:text-${color}-800">${label1}</span></div><i class="fa-solid fa-arrow-up-right-from-square text-xs text-${color}-400"></i></a>` : `<button onclick="openModal('${type}', ${index})" class="w-full flex items-center justify-between p-3 rounded-lg border border-dashed border-${color}-200 text-center text-xs text-${color}-400 hover:bg-${color}-50 hover:border-${color}-300 transition"><span class="w-full">Add ${label1} +</span></button>`}
                            ${type === 'flight' ? (item.link2 ? `<a href="${item.link2}" target="_blank" class="flex items-center justify-between p-3 rounded-lg border border-purple-100 bg-purple-50/50 hover:bg-purple-100 transition group"><div class="flex items-center space-x-3"><div class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-purple-600 shadow-sm"><i class="fa-solid fa-ticket"></i></div><span class="text-sm font-medium text-gray-700 group-hover:text-purple-800">${label2}</span></div><i class="fa-solid fa-arrow-up-right-from-square text-xs text-purple-400"></i></a>` : `<button onclick="openModal('${type}', ${index})" class="w-full flex items-center justify-between p-3 rounded-lg border border-dashed border-purple-200 bg-purple-50/30 hover:bg-purple-50 hover:border-purple-300 transition group cursor-pointer"><div class="flex items-center space-x-3"><div class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-gray-300 shadow-sm group-hover:text-purple-400"><i class="fa-solid fa-plus"></i></div><span class="text-sm font-medium text-gray-400 group-hover:text-purple-600">Add ${label2}</span></div></button>`) : ''}
                        </div>
                    </div>`;
            });
        }
        
        function renderContacts() {
            const data = loadData('contact');
            const container = document.getElementById('contacts-container');
            if(!container) return;
            container.innerHTML = '';
            
            data.forEach((item, index) => {
                const colors = ['blue', 'purple', 'teal', 'orange'];
                const color = item.color || colors[index % colors.length];
                const initial = item.title.charAt(0);
                const isMain = (item.title === 'Shreyans' || item.title === 'Samridhi');
                
                const avatar = item.image 
                    ? `<img src="${item.image}" class="w-10 h-10 rounded-full object-cover border border-${color}-200" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">` 
                    : '';
                const fallback = `<div class="w-10 h-10 bg-${color}-100 rounded-full flex items-center justify-center text-${color}-600 font-bold uppercase" style="${item.image ? 'display:none' : ''}">${initial}</div>`;
                
                container.innerHTML += `
                    <div class="bg-${color}-50 rounded-xl p-3 flex flex-col items-center justify-center space-y-2 border border-${color}-100 relative group">
                        <div class="absolute top-1 right-1 flex space-x-1">
                            <button onclick="openModal('contact', ${index})" class="text-${color}-200 hover:text-${color}-600 transition p-1"><i class="fa-solid fa-pen-to-square text-xs"></i></button>
                            ${!isMain ? `<button onclick="deleteItem('contact', ${index})" class="text-${color}-200 hover:text-red-500 transition p-1"><i class="fa-solid fa-trash text-xs"></i></button>` : ''}
                        </div>
                        ${avatar}${fallback}
                        <div class="text-center leading-tight"><span class="font-semibold text-sm block">${item.title}</span><span class="text-[10px] text-gray-500 uppercase">${item.date}</span></div>
                        <div class="flex space-x-2 w-full">
                            <a href="tel:${item.link1}" class="flex-1 bg-white hover:bg-${color}-600 hover:text-white text-${color}-600 py-2 rounded-lg text-center transition shadow-sm border border-${color}-100"><i class="fa-solid fa-phone"></i></a>
                            <a href="https://wa.me/${item.link2 || item.link1}" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg text-center shadow-sm"><i class="fa-brands fa-whatsapp"></i></a>
                        </div>
                    </div>`;
            });
            container.innerHTML += `<button onclick="openModal('contact')" class="bg-gray-50 rounded-xl p-3 flex flex-col items-center justify-center space-y-2 border-2 border-dashed border-gray-200 text-gray-400 hover:bg-gray-100 hover:border-gray-300 transition"><div class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm"><i class="fa-solid fa-plus"></i></div><span class="font-medium text-xs">Add New</span></button>`;
        }
        
        function renderMaps() {
            const data = loadData('map');
            const container = document.getElementById('maps-container');
            if(!container) return;
            container.innerHTML = '';
            
            data.forEach((map, index) => {
                const mapLink = map.query.startsWith('http') ? map.query : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(map.query)}`;
                container.innerHTML += `
                    <div class="block bg-white rounded-xl p-4 shadow-sm border border-gray-100 hover:bg-gray-50 transition relative group">
                         <div class="absolute top-4 right-2 flex space-x-2 z-20">
                            <button onclick="openModal('map', ${index})" class="text-gray-300 hover:text-teal-600 transition p-1"><i class="fa-solid fa-pen-to-square"></i></button>
                            <button onclick="deleteItem('map', ${index})" class="text-gray-300 hover:text-red-500 transition p-1"><i class="fa-solid fa-trash"></i></button>
                        </div>
                        <a href="${mapLink}" target="_blank" class="flex items-center justify-between pr-16">
                            <div class="flex items-center space-x-4"><div class="w-10 h-10 rounded-full bg-teal-50 flex items-center justify-center text-teal-600"><i class="fa-solid fa-map-location-dot"></i></div><div><h4 class="font-bold text-gray-800">${map.title}</h4><p class="text-xs text-gray-500">${map.loc}</p></div></div>
                            <i class="fa-solid fa-chevron-right text-gray-300 text-sm"></i>
                        </a>
                    </div>`;
            });
        }
        
        function renderTranslations() {
            const container = document.getElementById('translate-container');
            if(!container) return;
            container.innerHTML = '';
            
            translations.forEach(t => {
                container.innerHTML += `
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex justify-between items-center">
                        <div><p class="text-xs text-gray-400 uppercase">English</p><p class="font-medium text-gray-800">${t.en}</p></div>
                        <div class="text-right flex flex-col items-end pl-4">
                            <p class="text-xs text-teal-600 uppercase">Sinhala</p>
                            <div class="flex items-center space-x-2 mt-1">
                                <button onclick="playAudio('${t.si}')" class="shrink-0 text-teal-600 hover:text-teal-700 active:scale-95 transition bg-teal-50 w-10 h-10 rounded-full flex items-center justify-center border border-teal-100 shadow-sm"><i class="fa-solid fa-volume-high text-sm"></i></button>
                                <p class="font-bold text-lg text-gray-800">${t.si}</p>
                            </div>
                        </div>
                    </div>`;
            });
        }

        function openModal(type, index = -1) {
            currentType = type; currentEditIndex = index;
            const modal = document.getElementById('universal-modal');
            const content = document.getElementById('universal-modal-content');
            const dateInput = document.getElementById('input-2');
            
            // Layout adjustments
            document.getElementById('group-2').style.display = 'block';
            document.getElementById('group-4').style.display = 'block';
            document.getElementById('drive-info-box').style.display = 'block';
            
            if(['flight', 'hotel', 'itinerary'].includes(type)) dateInput.type = 'date'; else dateInput.type = 'text';
            
            // Labels and Placeholders
            if(type === 'flight') {
                document.getElementById('modal-title').innerText = index > -1 ? "Edit Flight" : "Add Flight";
                document.getElementById('label-1').innerText = "Flight Name";
                document.getElementById('label-2').innerText = "Date";
                document.getElementById('label-3').innerText = "Ticket Link";
                document.getElementById('label-4').innerText = "Boarding Pass Link";
            } else if(type === 'hotel') {
                document.getElementById('modal-title').innerText = index > -1 ? "Edit Hotel" : "Add Hotel";
                document.getElementById('label-1').innerText = "Hotel Name";
                document.getElementById('label-2').innerText = "Check-in Date";
                document.getElementById('label-3').innerText = "Booking Link";
                document.getElementById('group-4').style.display = 'none';
            } else if(type === 'visa') {
                document.getElementById('modal-title').innerText = index > -1 ? "Edit Document" : "Add Document";
                document.getElementById('label-1').innerText = "Document Name";
                document.getElementById('label-2').innerText = "Validity";
                document.getElementById('label-3').innerText = "Link";
                document.getElementById('group-4').style.display = 'none';
            } else if(type === 'contact') {
                document.getElementById('modal-title').innerText = index > -1 ? "Edit Contact" : "Add Contact";
                document.getElementById('label-1').innerText = "Name";
                document.getElementById('label-2').innerText = "Role";
                document.getElementById('label-3').innerText = "Phone";
                document.getElementById('label-4').innerText = "WhatsApp";
                document.getElementById('drive-info-box').style.display = 'none';
            } else if(type === 'map') {
                document.getElementById('modal-title').innerText = index > -1 ? "Edit Location" : "Add Location";
                document.getElementById('label-1').innerText = "Location Name";
                document.getElementById('label-2').innerText = "City";
                document.getElementById('label-3').innerText = "Maps Link";
                document.getElementById('group-4').style.display = 'none';
                document.getElementById('drive-info-box').style.display = 'none';
            } else if(type === 'itinerary') {
                document.getElementById('modal-title').innerText = index > -1 ? "Edit Plan" : "Add Plan";
                document.getElementById('label-1').innerText = "Title";
                document.getElementById('label-2').innerText = "Date";
                document.getElementById('label-3').innerText = "Location";
                document.getElementById('label-4').innerText = "Details";
                document.getElementById('drive-info-box').style.display = 'none';
            }

            if (index > -1) {
                const data = loadData(type)[index];
                document.getElementById('input-1').value = data.title || '';
                document.getElementById('input-2').value = data.date || data.loc || '';
                document.getElementById('input-3').value = data.link1 || data.query || data.loc || '';
                document.getElementById('input-4').value = data.link2 || data.details || '';
            } else {
                document.getElementById('input-1').value = '';
                document.getElementById('input-2').value = '';
                document.getElementById('input-3').value = '';
                document.getElementById('input-4').value = '';
            }
            modal.classList.remove('hidden');
            setTimeout(() => { content.classList.remove('scale-95', 'opacity-0'); content.classList.add('scale-100', 'opacity-100'); }, 10);
        }

        function closeModal() {
            const modal = document.getElementById('universal-modal');
            const content = document.getElementById('universal-modal-content');
            content.classList.remove('scale-100', 'opacity-100'); content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => { modal.classList.add('hidden'); }, 200);
        }

        function saveItem() {
            const val1 = document.getElementById('input-1').value;
            const val2 = document.getElementById('input-2').value;
            const val3 = document.getElementById('input-3').value;
            let val4 = document.getElementById('input-4').value;

            if(!val1) { alert("Please enter a Title/Name"); return; }
            
            let newItem = {};
            if(currentType === 'map') newItem = { title: val1, loc: val2, query: val3 };
            else if(currentType === 'itinerary') newItem = { title: val1, date: val2, loc: val3, details: val4, icon: 'fa-calendar-day' };
            else {
                if(currentType === 'contact' && !val4) val4 = val3;
                newItem = { title: val1, date: val2, link1: val3, link2: val4 };
            }

            const data = loadData(currentType);
            if (currentEditIndex > -1) data[currentEditIndex] = newItem; else data.push(newItem);
            if(currentType === 'itinerary') data.sort((a, b) => new Date(a.date) - new Date(b.date));

            saveData(currentType, data);
            
            if(currentType === 'contact') renderContacts();
            else if(currentType === 'map') renderMaps();
            else if(currentType === 'itinerary') renderItinerary();
            else renderList(currentType);
            
            closeModal();
        }

        // Init
        const inrInput = document.getElementById('inr-input');
        const lkrOutput = document.getElementById('lkr-output');
        if (inrInput && lkrOutput) {
             inrInput.addEventListener('input', (e) => {
                const val = parseFloat(e.target.value);
                lkrOutput.innerText = isNaN(val) ? "0.00" : (val * 3.44).toFixed(2);
            });
        }
        
        // PWA Install Logic
        let deferredPrompt;
        const installCard = document.getElementById('install-prompt');
        const iosHint = document.getElementById('ios-install-hint');
        const manualText = document.getElementById('manual-install-text');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault(); deferredPrompt = e;
            if (manualText) manualText.classList.add('hidden');
        });

        window.addEventListener('appinstalled', () => {
            if (installCard) installCard.classList.add('hidden');
            if (iosHint) iosHint.classList.add('hidden');
            deferredPrompt = null;
            localStorage.setItem('isAppInstalled', 'true');
        });

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        if (installCard) installCard.classList.add('hidden');
                        localStorage.setItem('isAppInstalled', 'true');
                    }
                    deferredPrompt = null;
                });
            } else {
                if (manualText) manualText.classList.remove('hidden');
                alert("To install: Tap the browser menu (‚ãÆ) and select 'Add to Home Screen' or 'Install App'.");
            }
        }

        function checkInstallStatus() {
            if (localStorage.getItem('isAppInstalled') === 'true') return;
            const isIos = /iPhone|iPad|iPod/.test(navigator.userAgent) && !window.MSStream;
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || ('standalone' in window.navigator && window.navigator.standalone);
            if (isStandalone) {
                if (installCard) installCard.classList.add('hidden');
                if (iosHint) iosHint.classList.add('hidden');
                return;
            }
            if (isIos) {
                if (iosHint) iosHint.classList.remove('hidden');
                if (installCard) installCard.classList.add('hidden');
            } else {
                if (installCard) installCard.classList.remove('hidden');
                if (iosHint) iosHint.classList.add('hidden');
            }
        }
        
        checkInstallStatus();
        const storedTab = localStorage.getItem('activeTab') || 'dashboard';
        switchTab(storedTab);
        
        renderItinerary();
        renderList('flight');
        renderList('hotel');
        renderList('visa');
        renderMaps();
        renderContacts();
        renderTranslations();

    </script>
</body>
</html>

